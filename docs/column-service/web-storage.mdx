---
title: æµè§ˆå™¨å­˜å‚¨ æ–¹å¼
id: web-storage
toc_max_heading_level: 4
---

```mdx-code-block
import { Image } from '@arco-design/web-react';
```

> æœ¬ç« èŠ‚ä»‹ç»å®¢æˆ·ç«¯çš„ä¸€äº›å­˜å‚¨æ•°æ®çš„æ–¹å¼ï¼Œæ¯”å¦‚ Cookieã€WebStorage ç­‰;

## Cookie

### åŸç”Ÿ JS æ“ä½œ Cookie

```ts title="è®¾ç½®(å­˜) cookieã€è®¾ç½®æœ‰æ•ˆæ—¶é—´"
const setCookie = (name, value, time) => {
  second = (second || second === 0) && `max-age=${second}`; // æœ‰æ•ˆæ—¶é—´ï¼Œå•ä½æ˜¯ ç§’
  document.cookie = `${name}=${value};${second};`;
};

// ç¤ºä¾‹:
setCookie('username', 'dino', 30);
```

```ts title="è¯»å– cookie"
const getCookie = (name: string) => {
  const cookies = document.cookie;
  const str = cookies.match(new RegExp('(^| )' + name + '=([^;]*)(;|$)')); // é€šè¿‡ match() + æ­£åˆ™æ¥åŒ¹é…å¯¹åº”çš„å€¼

  if (str !== null) return str[2];
  return null;
};
```

```js title="åˆ é™¤ cookie"
// åˆ é™¤ä¸€ä¸ª cookie æ—¶ï¼Œå¯ä»¥å°†è¯¥ cookie çš„æœ‰æ•ˆæ—¶é—´è®¾ç½®ä¸º 0 æˆ–è€… è´Ÿæ•°
const removeCookie = (name: string) => {
  setCookie(name, '', 0);
};
```

### ç¬¬ä¸‰æ–¹åº“æ“ä½œ Cookie

- å®‰è£… `js-cookie` æ’ä»¶

```bash npm2yarn
npm install --save js-cookie
```

- ä½¿ç”¨æ–¹æ³•(éƒ¨åˆ†)

```js
import Cookies from 'js-cookie';

// å­˜å‚¨ cookieï¼Œå…è®¸è®¾ç½® JSON å¯¹è±¡
Cookies.set('key', 'value'); // å­˜å‚¨æ™®é€šçš„ string
Cookies.set('key', JSON.stringify({ ... })); // å­˜å‚¨ JSON å¯¹è±¡

// å­˜å‚¨ cookieï¼Œå¹¶è®¾ç½® cookie çš„æœ‰æ•ˆæ—¶é—´ï¼Œpathï¼Œdomain ç­‰å±æ€§
Cookies.set('key', 'value', { expires: 1, path: '/', secure: true, domain: '...' });

// è·å– cookie
Cookies.get('key'); // è·å–æ™®é€šçš„ string
JSON.parse(Cookies.get('key')); // è·å– JSON å¯¹è±¡

// åˆ é™¤ cookie
Cookies.remove('key');
```

:::info ç¦»ç¦»åŸä¸Šè°±

`js-cookie` åœ¨å­˜å‚¨å€¼æ—¶ï¼Œå…¶ä¸­çš„ `expires` å±æ€§ä»£è¡¨è¿‡æœŸæ—¶é—´ï¼Œå®ƒæ˜¯ä¸€ä¸ª **number(å•ä½ä¸º å¤©)** æˆ– **Date** ç±»å‹;

:::

## localStorage

- å®ƒæ˜¯ **WebStorage** ä¸­çš„ä¸€ç§å­˜å‚¨æ–¹å¼ï¼Œå®ƒçš„æ•°æ® **å¯é•¿æœŸå­˜å‚¨åœ¨äºå®¢æˆ·ç«¯çš„ç¡¬ä»¶è®¾å¤‡(ç¡¬ç›˜)ä¸­**ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ä¸­çš„å†å²è®°å½•æˆ–å­˜å‚¨æ•°æ®ï¼Œä¸ä¸æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡;
- å­˜å€¼æ—¶ï¼Œéœ€ä»¥ `key, value(é”®å€¼å¯¹)` çš„æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œä¸”ç±»å‹åªèƒ½æ˜¯ **å­—ç¬¦ä¸²**;
- localStorage çš„æ–¹æ³•å¦‚ä¸‹:

```js title="å­˜å€¼"
window.localStorage.setItem('key', 'value'); // å­˜å‚¨æ™®é€šçš„ string
window.localStorage.setItem('key', JSON.stringify({ ... })); // å­˜å‚¨ JSON å¯¹è±¡
```

```js title="è¯»å–å€¼"
window.localStorage['key']; // localStorage æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡
window.localStorage.getItem('key');
JSON.parse(window.localStorage.getItem('key')); // è·å– JSON å¯¹è±¡

window.localStorage.valueOf(); // è·å–å…¨éƒ¨çš„ localStorageï¼Œè¿”å›ä¸€ä¸ªç±»æ•°ç»„
```

```js title="åˆ é™¤å€¼"
window.localStorage.removeItem('key');

window.localStorage.clear(); // æ¸…ç©ºæ‰€æœ‰çš„ localStorage
```

:::tip æ‹“å±•èµ„æ–™

- ğŸ‘‰ [é¢è¯•å®˜: å¦‚ä½•è®© localStorage æ”¯æŒè¿‡æœŸæ—¶é—´è®¾ç½®? - å¾®ä¿¡](https://mp.weixin.qq.com/s/TQC2NsTnh_bHvL-cDjwUQw)

:::

## sessionStorage

- å®ƒåŒ localStorage çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«å°±æ˜¯å®ƒçš„æ•°æ® **åªå­˜åœ¨äºæµè§ˆå™¨çš„ä¼šè¯æœŸé—´ï¼Œå³ç½‘é¡µçª—å£(æ ‡ç­¾é¡µ)å…³é—­ï¼Œè¯¥æ•°æ®å°±ä¼šè¢«æ¸…é™¤**;
- sessionStorage çš„éƒ¨åˆ†æ–¹æ³•å¦‚ä¸‹(åŒ localStorage å®Œå…¨ä¸€è‡´):

```js
// å­˜å€¼
window.sessionStorage.setItem('key', 'value');

// å–å€¼
window.sessionStorage.getItem('key');

// åˆ é™¤å€¼
window.sessionStorage.removeItem('key');

// æ¸…ç©ºæ‰€æœ‰å€¼
window.sessionStorage.clear();
```

:::info ç¦»ç¦»åŸä¸Šè°±

sessionStorage å­˜å‚¨çš„æ•°æ®æ˜¯ä¸ç¬¦åˆ **åŒæºå…±äº«** çš„ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ä¸ªé¡µé¢åœ¨ä¸åŒçš„çª—å£æ‰“å¼€ï¼Œå…¶æ•°æ®æ˜¯ä¸å…±äº«çš„;

:::

## IndexedDB

##### ä»€ä¹ˆæ˜¯ IndexedDB?

- IndexedDB æ˜¯ä¸€ç§ä½çº§çš„ APIï¼Œç”¨äº **å®¢æˆ·ç«¯å¤§é‡å­˜å‚¨ç»“æ„åŒ–çš„æ•°æ®(å¦‚: æ–‡ä»¶ã€äºŒè¿›åˆ¶æ•°æ®ç­‰)**ï¼Œç®€å•æ¥è¯´å®ƒå°±æ˜¯ä¸€ä¸ª **è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„ éå…³ç³»å‹æ•°æ®åº“**ï¼Œä¸”å®ƒçš„æ•°æ®åŒ localStorage ä¸€æ ·ï¼Œä¹Ÿæ˜¯å­˜å‚¨åœ¨ **æœ¬åœ°ç£ç›˜** ä¸­çš„;
- IndexedDB çš„å†…éƒ¨æ˜¯é‡‡ç”¨ **å¯¹è±¡ä»“åº“(object store)** å­˜æ”¾æ•°æ®çš„ï¼Œä¹Ÿå°±æ˜¯æ•°æ®è¡¨(å¯ä»¥æœ‰è‹¥å¹²ä¸ª)ï¼Œä»»ä½•ç±»å‹çš„æ•°æ®éƒ½å¯ä»¥ç›´æ¥å­˜å…¥ï¼›å¯¹è±¡ä»“åº“ä¸­ï¼Œæ•°æ®ä»¥ **é”®å€¼å¯¹** çš„æ–¹å¼ä¿å­˜ï¼Œæ¯ä¸€æ¡æ•°æ®éƒ½æœ‰å…¶å¯¹åº”çš„ **ä¸»é”®**ï¼Œä¸”ä¸»é”®æ˜¯ **å”¯ä¸€çš„ï¼Œä¸èƒ½æœ‰é‡å¤**ï¼Œå¦åˆ™ä¼šæŠ¥é”™;
- IndexedDB çš„ **æ“ä½œæ˜¯ å¼‚æ­¥(è¯·æ±‚ - å“åº”) çš„**ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢å¤§é‡æ•°æ®å†™å…¥æ—¶ï¼Œæ‹–æ…¢ç½‘é¡µ;
- IndexedDB æ”¯æŒ [_æ•°æ®åº“äº‹åŠ¡(transaction)_](https://www.liaoxuefeng.com/wiki/1177760294764384/1179611198786848)ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ç³»åˆ—æ“ä½œæ­¥éª¤ä¹‹ä¸­ï¼Œåªè¦æœ‰ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å°±éƒ½ä¼šå–æ¶ˆ(æ¯”å¦‚ è½¬è´¦çš„æ“ä½œ)ï¼Œæ•°æ®åº“å›æ»šåˆ°äº‹åŠ¡å‘ç”Ÿä¹‹å‰çš„çŠ¶æ€ï¼Œä¸å­˜åœ¨åªæ”¹å†™ä¸€éƒ¨åˆ†æ•°æ®çš„é—®é¢˜;

##### IndexedDB çš„ä¸»è¦å®ä¾‹å¯¹è±¡

| å®ä¾‹å¯¹è±¡         | è¯´æ˜                                                 |
| ---------------- | ---------------------------------------------------- |
| `IDBDatabase`    | **æ•°æ®åº“**                                           |
| `IDBObjectStore` | **ä»“åº“å¯¹è±¡ï¼Œå­˜å‚¨ç©ºé—´**                               |
| `IDBIndex`       | **ç´¢å¼•**ï¼Œç”¨ä¸åŒçš„å±æ€§å»ºç«‹ç´¢å¼•å¯ä»¥åŠ å¿«æ•°æ®çš„æ£€ç´¢     |
| `IDBTransaction` | **äº‹åŠ¡**ï¼Œæ•°æ®çš„ CURD(å¢åˆ æŸ¥æ”¹) éƒ½éœ€è¦é€šè¿‡äº‹åŠ¡æ¥å®Œæˆ |
| `IDBKeyRange`    | **ä¸»é”®**ï¼Œå…·æœ‰å”¯ä¸€æ€§                                 |
| `IDBCursor`      | **æŒ‡é’ˆ**                                             |

### åŸç”Ÿæ“ä½œ IndexedDB

##### æ£€æµ‹ IndexedDB æ˜¯å¦è¢«æµè§ˆå™¨æ”¯æŒ

```js
if ('indexedDB' in window) {
  console.log('å½“å‰æµè§ˆå™¨æ”¯æŒ IndexedDB');
  // ... æ“ä½œæ•°æ®åº“
} else {
  console.log('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB, å»ºè®®å‡çº§æˆ–è€…æ›´æ¢å…¶ä»–æµè§ˆå™¨');
}
```

##### åˆ›å»ºæˆ–æ‰“å¼€æ•°æ®åº“

- ä½¿ç”¨ `window.indexedDB.open(dbName, version)` è¿™ä¸ª API æ¥åˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªæ•°æ®åº“(å¯åˆ›å»ºå¤šä¸ªæ•°æ®åº“)ï¼Œè¯¥ API çš„å‚æ•°ä»‹ç»å¦‚ä¸‹;

| å‚æ•°      | è¯´æ˜                                                                                              | ç±»å‹     |
| --------- | ------------------------------------------------------------------------------------------------- | -------- |
| `dbName`  | è‡ªå®šä¹‰ä¸€ä¸ªæ•°æ®åº“åç§°                                                                              | `string` |
| `version` | æŒ‡å®š/æ›´æ–° æ•°æ®åº“çš„ç‰ˆæœ¬å·ï¼Œæ˜¯ä¸€ä¸ª **æ•´æ•°**ï¼Œé»˜è®¤ä¸º 1ï¼›å½“éœ€è¦åˆ›å»ºæ•°æ®è¡¨æˆ–ç´¢å¼•æ—¶ï¼Œå¯æŒ‡å®šå¹¶å‡çº§ç‰ˆæœ¬å· | `number` |

- å½“æ•°æ®åº“å»ºç«‹è¿æ¥æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª `IDBOpenDBRequest` å¯¹è±¡ï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªäº‹ä»¶:

```js
const IDBOpenDBRequest = window.indexedDB.open('dbName', 1);
console.log('IDBOpenDBRequest: ', IDBOpenDBRequest); // è¿”å›ä¸€ä¸ª IDBOpenDBRequest å¯¹è±¡

// ğŸ”… æ•°æ®åº“æ‰“å¼€æˆåŠŸçš„äº‹ä»¶
IDBOpenDBRequest.onsuccess = (event) => {
  // event.target æ˜¯ IDBOpenDBRequest å®ä¾‹å¯¹è±¡
  // event.target.result æ˜¯ IDBDatabase å®ä¾‹å¯¹è±¡
  console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸ');
};

// æ•°æ®åº“æ‰“å¼€å¤±è´¥çš„äº‹ä»¶
IDBOpenDBRequest.onerror = (event) => {
  console.log('æ•°æ®åº“æ‰“å¼€å‡ºé”™');
};

// ğŸ”… é¦–æ¬¡æ–°å»ºæ•°æ®åº“ & æ›´æ–°æ•°æ®åº“ç‰ˆæœ¬æ—¶è§¦å‘çš„äº‹ä»¶ï¼ˆå½“å­˜åœ¨æ•°æ®åº“æ—¶ï¼Œä¼šåˆ¤æ–­ç‰ˆæœ¬å·ï¼Œå¦‚æœæŒ‡å®šçš„ç‰ˆæœ¬å·é«˜äºå·²æœ‰çš„ç‰ˆæœ¬å·ï¼Œåˆ™ä¼šè§¦å‘è¯¥äº‹ä»¶ï¼‰
// è¯¥äº‹ä»¶ä¼šæ¯” onsuccess äº‹ä»¶å…ˆæ‰§è¡Œ
IDBOpenDBRequest.onupgradeneeded = (event) => {
  console.log('æ•°æ®åº“åˆ›å»ºæˆåŠŸ / ç‰ˆæœ¬å‡çº§æˆåŠŸ');
  // ... åˆ›å»ºä»“åº“å¯¹è±¡
};
```

##### åˆ›å»ºä»“åº“å¯¹è±¡(å­˜å‚¨ç©ºé—´ & æ•°æ®è¡¨)

- æ•°æ®åº“æˆåŠŸæ‰“å¼€åï¼Œåªèƒ½åœ¨ `onupgradeneeded` è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­åˆ›å»ºä»“åº“å¯¹è±¡;
- é€šè¿‡ `createObjectStore(storeName, options)` æ–¹æ³•æ¥åˆ›å»ºä»“åº“å¯¹è±¡ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°ä»‹ç»å¦‚ä¸‹:

| å‚æ•°                    | è¯´æ˜                                                       | ç±»å‹      |
| ----------------------- | ---------------------------------------------------------- | --------- |
| `storeName`             | å­˜å‚¨ç©ºé—´å¯¹è±¡çš„åç§°                                         | `string`  |
| `options.keyPath`       | å­˜å‚¨ç©ºé—´å¯¹è±¡çš„ä¸»é”®ï¼Œè‹¥ä¸è®¾ç½®ï¼ŒindexedDB ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸»é”® | `string`  |
| `options.autoIncrement` | æŒ‡å®š `keyPath` çš„å€¼æ˜¯å¦è‡ªå¢                                | `boolean` |

- é€šè¿‡ `createIndex(indexName, keyPath, options)` æ–¹æ³•æ¥ç»™æŒ‡å®šçš„å­˜å‚¨ç©ºé—´å¯¹è±¡è®¾ç½®ä¸€ä¸ª **ç´¢å¼•**ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°ä»‹ç»å¦‚ä¸‹:

| å‚æ•°             | è¯´æ˜                                  | ç±»å‹      |
| ---------------- | ------------------------------------- | --------- |
| `indexName`      | ç´¢å¼•åç§°ï¼Œå¯ä»¥ä¸ºç©º                    | `string`  |
| `keyPath`        | æ ¹æ®å­˜å‚¨æ•°æ®ä¸­çš„å“ªä¸€ä¸ªå±æ€§æ¥ æ„å»ºç´¢å¼• | `string`  |
| `options.unique` | æŒ‡å®šç´¢å¼•å€¼æ˜¯å¦å”¯ä¸€ï¼Œä¸èƒ½é‡å¤          | `boolean` |

```js title="ä»£ç ç¤ºä¾‹"
const IDBOpenDBRequest = window.indexedDB.open('dbName', 1);

IDBOpenDBRequest.onupgradeneeded = (event) => {
  const db = event.target.result; // è¿”å›ä¸€ä¸ª IDBDatabase å®ä¾‹å¯¹è±¡
  const transaction = event.target.transaction; // è¿”å›ä¸€ä¸ª IDBTransaction å®ä¾‹å¯¹è±¡

  // ğŸ”… åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å­˜å‚¨å¯¹è±¡(æ•°æ®è¡¨)ï¼Œå¹¶æŒ‡å®šä¸»é”®
  let objectStore;
  // åœ¨åˆ›å»ºæ•°æ®è¡¨ä¹‹å‰å…ˆåˆ¤æ–­ä¸€ä¸‹åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥è¡¨ï¼Œè‹¥ä¸å­˜åœ¨æ‰è¿›è¡Œåˆ›å»º
  // åˆ›å»ºä¸€ä¸ªåç§°ä¸º person çš„æ•°æ®è¡¨
  if (!db.objectStoreNames.contains('person')) {
    objectStore = db.createObjectStore('person', {
      keyPath: 'id', // ä¸»é”®ä¸ºè¯¥æ•°æ®è¡¨ä¸­çš„ id å±æ€§ï¼Œä¾‹å¦‚æ•°æ® { id: 1, name: '...' }
      autoIncrement: true,
    });
    // ğŸ”… åˆ›å»ºè¯¥æ•°æ®è¡¨çš„åˆå§‹ç´¢å¼•å­—æ®µï¼Œå¦‚æœæ•°æ®è¡¨ä¸­æœ‰å¤šå°‘ä¸ªå±æ€§ï¼Œå°±å»ºç«‹å¤šå°‘ä¸ªç´¢å¼•å­—æ®µ
    objectStore.createIndex('id', 'id', { unique: true });
    objectStore.createIndex('name', 'namme');
    // ...
  } else {
    objectStore = transaction.getObjectStore('person'); // è‹¥å­˜åœ¨åŒåçš„æ•°æ®è¡¨ï¼Œç›´æ¥å–å‡ºæ¥
    objectStore.createIndex('params', ['name', 'id'], { unique: false }); // åˆ›å»ºä¸€ä¸ªç»„åˆå­—æ®µçš„ç´¢å¼•ï¼Œä¾¿äºå¤šæ¡ä»¶æŸ¥è¯¢æ•°æ®
    // ...
  }

  // ... ç»§ç»­åˆ›å»ºå…¶ä»–æ•°æ®è¡¨
};
```

åˆ›å»ºæˆåŠŸåå¯åœ¨æµè§ˆå™¨çš„ **Application** ä¸­çœ‹åˆ°çš„æ•ˆæœå¦‚ä¸‹:

<!--
<Image src={require('./img/indexeddb.jpg').default} width='90%' />
 -->

<Image src='//aone-time.icu/group1/dino/column-service/indexeddb.jpg' width='90%' />

##### å‘æ•°æ®è¡¨ä¸­ æ·»åŠ  / åˆ é™¤ / ä¿®æ”¹ æ•°æ®

- é€šè¿‡ `transaction(storeName, operationType)` æ–¹æ³•å…ˆ **å»ºç«‹ä¸€ä¸ªäº‹åŠ¡**ï¼Œæ‰èƒ½ç»§ç»­å¯¹æ•°æ®çš„æ“ä½œï¼Œè¯¥æ–¹æ³•çš„å‚æ•°ä»‹ç»å¦‚ä¸‹:

| å‚æ•°            | è¯´æ˜               | ç±»å‹                                     |
| --------------- | ------------------ | ---------------------------------------- |
| `storeName`     | æ•°æ®è¡¨åç§°         | `string` or `string[]`                   |
| `operationType` | å¯¹æ•°æ®è¡¨çš„æ“ä½œæ¨¡å¼ | `readwrite`: è¯»å†™ <br />`readonly`: åªè¯» |

```js title="ä»£ç ç¤ºä¾‹"
let db; // æ•°æ®åº“å®ä¾‹å¯¹è±¡
const IDBOpenDBRequest = window.indexedDB.open('testDB', 1);

IDBOpenDBRequest.onsuccess = (event) => {
  db = event.target.result;
};

// ... çœç•¥äº†åˆ›å»ºæ•°æ®è¡¨çš„æ­¥éª¤

console.log('db: ', db); // â é”™è¯¯ç¤ºèŒƒï¼Œç”±äºæ˜¯å¼‚æ­¥æ“ä½œï¼Œdb æ˜¯ç›´æ¥å–ä¸åˆ°å€¼çš„

// ğŸ”… å»ºç«‹ä¸€ä¸ªäº‹åŠ¡ï¼ˆå°è£…ä¸€ä¸ªç®€æ˜“çš„å…¬å…±æ–¹æ³•ï¼Œè¿”å›æŒ‡å®šçš„æ•°æ®è¡¨å¯¹è±¡ï¼‰
const getObjectStore = (storeName: string | string[], optionsType = 'readwrite') => {
  const transaction = db.transaction(storeName, optionsType);
  // æ‰¾åˆ°è¦æ“ä½œçš„æ•°æ®è¡¨å¯¹è±¡å®ä¾‹
  return transaction.objectStore(storeName);
};

// ğŸ”… æ·»åŠ æ•°æ®ï¼ˆæŒ‡å®š data ä¸ºè¦æ·»åŠ çš„æ•°æ®ï¼‰
const handleAdd = (data: any) => {
  const store = getObjectStore('storeName');
  store.add(data); // æ·»åŠ æ•°æ®
};

// ğŸ”… é€šè¿‡ ä¸»é”® åˆ é™¤å•æ¡æ•°æ®ï¼ˆæŒ‡å®šä¸»é”®å€¼ä¸º idï¼‰
const handleRemove = (id: number) => {
  const store = getObjectStore('storeName');
  store.delete(id); // åˆ é™¤æ•°æ®ï¼Œä¼ å…¥è¦åˆ é™¤çš„æ•°æ®çš„ä¸»é”®
};

// ğŸ”… é€šè¿‡ ç´¢å¼• + æ¸¸æ ‡ æ‰¹é‡åˆ é™¤æ•°æ®ï¼ˆæŒ‡å®š indexName ä¸ºç´¢å¼•åç§°ï¼Œvalue ä¸ºç´¢å¼•å¯¹åº”çš„æ•°æ®çš„å€¼ï¼Œæ¯”å¦‚è¦æŸ¥è¯¢ name: 'dino' è¿™æ¡æ•°æ®ï¼Œæ­¤æ—¶ value å°±å¯ä»¥ä¼ å…¥ 'dino'ï¼‰
const handleRemoveByCursor = (indexName: string, value: string | any[]) => {
  const store = getObjectStore('storeName');
  const storeRequest = store.index(indexName).openCursor(IDBKeyRange.only(value));

  storeRequest.onsuccess = (event) => {
    const res = event.target.result; // è¿”å›ä¸»é”®å¯¹åº”çš„æ•°æ®
    if (res) {
      res.delete(); // åˆ é™¤æ¸¸æ ‡æŒ‡å®šçš„æ•°æ®
      res.continue(); // ä½¿æ¸¸æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€é¡¹æ•°æ®ï¼Œç›¸å½“äºå®ç°äº†æ•°æ®çš„éå†
    }
  };
  storeRequest.onerror = () => {};
};

// ğŸ”… ä¿®æ”¹æ•°æ®ï¼ˆæŒ‡å®š newRecord ä¸ºæ–°æ•°æ®ï¼‰
const handleUpdata = (id: number, newRecord: any) => {
  const store = getObjectStore('storeName');
  // æ ¹æ®ä¸»é”®æŸ¥æ‰¾å…¶å¯¹åº”çš„æ•°æ®
  const storeRequest = store.get(id); // ä¼ å…¥ä¸»é”®çš„å€¼ï¼Œè¿”å›ä¸€ä¸ª IDBRequest å®ä¾‹å¯¹è±¡

  storeRequest.onsuccess = (event) => {
    const record = event.target.result;
    // å½“æ–°æ•°æ®ä¸º js å¯¹è±¡æ—¶ï¼Œè¦éå†æ–°æ•°æ®ï¼Œå’Œæ•°æ®è¡¨ä¸­çš„æ•°æ®è¿›è¡Œæ¯”å¯¹ï¼Œå¹¶ä¸”ä¸èƒ½ä¿®æ”¹ä¸»é”®çš„å€¼ï¼Œä»¥é˜²è§¦å‘æ–°å¢çš„é€»è¾‘
    for (const key in newRecord) {
      if (Object.hasOwnProperty.call(record, key) && key !== 'id') {
        record[key] = newRecord[key];
      }
    }

    store.put(record); // ä¿®æ”¹æ•°æ®
  };
};

// ğŸ”… é€šè¿‡ ä¸»é”® è¯»å–æ•°æ®
const getDataByKey = (id: number) => {
  // ä½¿ç”¨ Promise çš„æ–¹å¼æ¥è¯»å–æ•°æ®
  return new Promise((resolve, reject) => {
    const store = getObjectStore('storeName', 'readonly');
    const storeRequest = store.get(id);

    storeRequest.onsuccess = (event) => {
      resolve(event.target.result);
    };
  });
};

// ğŸ”… é€šè¿‡ ç´¢å¼• è¯»å–æ•°æ®
const getDataByIndex = (indexName: string, value: string | any[]) => {
  return new Promise((resolve, reject) => {
    const store = getObjectStore('storeName', 'readonly');
    const storeRequest = store.index(indexName).get(value);

    storeRequest.onsuccess = (event) => {
      resolve(event.target.result);
    };
  });
};

// ğŸ”… é€šè¿‡ ç´¢å¼• + æ¸¸æ ‡ è¯»å–æ•°æ®ï¼ˆè¯»å–æ•°æ®è¡¨ä¸­çš„å…¨éƒ¨æ•°æ® or éƒ¨åˆ†æ•°æ®ï¼‰
const getDataByCursor = (indexName: string, value: string | any[]) => {
  return new Promise((resolve, reject) => {
    const list = [];
    const store = getObjectStore('storeName', 'readonly');

    // ğŸ åˆ›å»ºä¸€ä¸ªæ¸¸æ ‡(æŒ‡é’ˆ)å¯¹è±¡ï¼Œç”¨æ¥è·å–å…¨éƒ¨ or æŒ‡å®šæ•°æ®ï¼Œå¸¸è§æœ‰ä»¥ä¸‹å‡ ç§:
    // ğŸ è·å–å…¨éƒ¨æ•°æ®
    const storeRequest = store.openCursor();

    // ğŸ æ ¹æ®ç´¢å¼•å­—æ®µ + å­—æ®µå€¼æ¥è·å–éƒ¨åˆ†æ•°æ®ï¼›å½“ value ä¸ºä¸€ä¸ªæ•°ç»„æ—¶ï¼Œä»£è¡¨å¤šæ¡ä»¶æŸ¥è¯¢ï¼ˆå‰ææ˜¯éœ€è¦åˆ›å»ºå…¶å¯¹åº”çš„ç´¢å¼•ç»„åˆï¼‰
    const storeRequest = store.index(indexName).openCursor(IDBKeyRange.only(value));

    // ğŸ è·å–æŒ‡å®šä¸»é”®èŒƒå›´å†…çš„æ•°æ®ï¼ˆæŒ‡å®š lower ä¸ºæœ€å°èŒƒå›´ï¼Œupper ä¸ºæœ€å¤§èŒƒå›´ï¼‰
    const storeRequest = store.openCursor(IDBKeyRange.bound(lower, upper)); // è·å–ä¸»é”®å€¼ >= lower & <= upper çš„èŒƒå›´

    storeRequest.onsuccess = (event) => {
      const res = event.target.result; // è¿”å›ä¸€ä¸ª IDBCursorWithValue å®ä¾‹å¯¹è±¡
      if (res) {
        list.push(res.value);
        res.continue();
      }
      resolve(list);
    };
  });
};

// ğŸ”… é€šè¿‡ ç´¢å¼• + æ¸¸æ ‡ è¿›è¡Œåˆ†é¡µè¯»å–æ•°æ®ï¼ˆæŒ‡å®š page ä¸ºé¡µç ï¼ŒpageSize ä¸ºæ¯é¡µä¸ªæ•°ï¼‰
const getDataByCursorPage = (
  indexName: string,
  value: string | any[],
  page: number,
  pageSize: number
) => {
  return new Promise((resolve, reject) => {
    const list = [];
    let counter = 0; // è®¡æ•°å™¨ï¼Œè®°å½•æ•°æ®éå†æ—¶çš„æ‰§è¡Œæ¬¡æ•°
    let advanced = true; // æ˜¯å¦æ‰§è¡Œè·³è¿‡æŸ¥è¯¢çš„é€»è¾‘
    let storeRequest;

    const store = getObjectStore('storeName', 'readonly');
    if (!indexName) {
      storeRequest = store.openCursor();
    } else {
      storeRequest = store.index(indexName).openCursor(IDBKeyRange.only(value));
    }

    storeRequest.onsuccess = (event) => {
      const res = event.target.result;

      // é¡µç å¤§äº 1 æ—¶ï¼Œæ‰å…è®¸æ‰§è¡Œè·³è¿‡çš„é€»è¾‘
      if (page > 1 && advanced) {
        // è‹¥ä¸è®¾ç½® advancedï¼Œåˆ™éå†æ•°æ®æ—¶ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šæ‰§è¡Œè·³è¿‡çš„é€»è¾‘ï¼Œå¯èƒ½å¯¼è‡´é¡µé¢æŠ¥é”™
        advanced = false;
        res.advanced((page - 1) * pageSize); // è·³è¿‡æŒ‡å®šæ•°é‡çš„æ•°æ®
        return;
      }
      if (res) {
        list.push(res.value);
        counter++;

        counter < pageSize && res.continue(); // è¡¨ç¤ºæ¸¸æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€é¡¹æ•°æ®ï¼›å½“ counter >= pageSize æ—¶åœæ­¢ç§»åŠ¨ï¼Œç›¸å½“äºåœæ­¢äº†éå†ï¼Œä¹Ÿå°±åœæ­¢äº†æŸ¥è¯¢ï¼›å½“ counter < pageSize æ—¶ï¼Œå¦‚æœä¸‹ä¸€é¡¹æ²¡æœ‰æ•°æ®ï¼Œåˆ™ res ä¸ºç©ºï¼›
      }
      resolve(list);
    };
  });
};
```

:::info ç¦»ç¦»åŸä¸Šè°±

- `IDBObjectStore.put()` æ–¹æ³•ä¸ä»…æœ‰ä¿®æ”¹æ›¿æ¢çš„ä½œç”¨ï¼Œå®ƒè¿˜èƒ½ **æ–°å¢æ•°æ®**ï¼Œæ¯”å¦‚è¦ä¿®æ”¹ä¸»é”®çš„å€¼æ—¶ï¼Œè¯¥æ–¹æ³•å°±ä¼šæ–°å¢ä¸€æ¡æ•°æ®ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ï¼Œå› ä¸º **ä¸»é”®å€¼å…·æœ‰å”¯ä¸€æ€§**;
- `IDBKeyRange` æ¥å£(å…¨å±€ä½¿ç”¨)ç”¨æ¥è¡¨ç¤ºæ•°æ®è¡¨ä¸­ä¸»é”®çš„åˆ†å‰²æ–¹å¼ï¼Œå¯ä»¥ç»“åˆ `IDBObjectStore.openCursor()` æˆ– `IDBObjectStore.get()` æ–¹æ³•ä¸€èµ·ä½¿ç”¨ï¼Œç”¨æ¥åˆ†å‰²æ•°æ®ï¼Œè·å–æŒ‡å®šçš„éƒ¨åˆ†æ•°æ®ï¼Œæ›´å¤šå†…å®¹å¯æŸ¥çœ‹ [_IDBKeyRange æ¥å£ - MDN_](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBKeyRange);
- `IDBCursorWithValue.advance()` æ–¹æ³•(æ¸¸æ ‡ã€æŒ‡é’ˆ)è¡¨ç¤º **è·³è¿‡å¤šå°‘æ¡æ•°æ®** å»æŸ¥è¯¢ï¼Œä¼ å…¥ä¸€ä¸ª **number** å³å¯;

:::

##### å…³é—­ / æ¸…ç©º æ•°æ®åº“

```js title="ä»£ç ç¤ºä¾‹"
let db;
const IDBOpenDBRequest = window.indexedDB.open('testDB', 1);

IDBOpenDBRequest.onsuccess = (event) => {
  db = event.target.result;
};

// å…³é—­æ•°æ®åº“ï¼ˆğŸ“¢ å…³é—­ä¹‹åï¼Œåˆ™ä¸èƒ½å†å¯¹æ•°æ®åº“è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰
const handleClosed = () => {
  db.close();
  console.log('æ•°æ®åº“å·²å…³é—­');
};

// åˆ é™¤æ•°æ®åº“ & æ¸…ç©ºæ•°æ®
const handleClear = () => {
  window.indexedDB.deleteDatabase('dbName');
  console.log('æ•°æ®åº“å·²åˆ é™¤');
};
```

### ç¬¬ä¸‰æ–¹åº“æ“ä½œ indexedDB

| ä¸‰æ–¹åº“                                                      | è¯´æ˜                                                                                                                                                                    | å‚è€ƒèµ„æ–™                                                                                                                                                                                                                    |
| ----------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [_localForage_](https://github.com/localForage/localForage) | ğŸ”… ä½¿ç”¨å¼‚æ­¥(Promise)çš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨ï¼Œå¹¶é‡‡ç”¨ä¼˜é›…é™çº§ç­–ç•¥ï¼Œä¼˜å…ˆä½¿ç”¨ IndexedDBï¼Œè‹¥æµè§ˆå™¨ä¸æ”¯æŒï¼Œåˆ™ä½¿ç”¨ localStorage;<br />ğŸ”… ä½†æ˜¯å¯¹ IndexedDB çš„æ–¹æ³•æ”¯æŒæ€§ä¸æ˜¯å¾ˆå‹å¥½; | ğŸ‘‰ [localForage ä¸­æ–‡æ–‡æ¡£](http://localforage.docschina.org/#localforage)                                                                                                                                                    |
| [_Dexie.js_](https://github.com/dexie/Dexie.js)             | ä¸€ä¸ªå°è£…äº† IndexedDB æ–¹æ³•çš„åº“ï¼Œæä¾›äº†è¾ƒå¤šç®€æ˜“çš„ APIï¼Œå¯¹ IndexedDB çš„æ“ä½œæ›´æ–¹ä¾¿;                                                                                         | ğŸ‘‰ [Dexie.js å®˜æ–¹æ–‡æ¡£](https://dexie.org)<br />ğŸ‘‰ [Dexie.js éƒ¨åˆ†ä½¿ç”¨æ–¹æ³• - æ˜é‡‘](https://juejin.cn/post/7025592963002531871#heading-3)<br />ğŸ‘‰ [åœ¨ React ä¸­ä½¿ç”¨ Dexie.js - å®˜æ–¹æ–‡æ¡£](https://dexie.org/docs/Tutorial/React) |

:::tip å‚è€ƒèµ„æ–™

- ğŸ‘‰ [IndexedDB API - ç½‘é“æ–‡æ¡£](https://wangdoc.com/javascript/bom/indexeddb.html)
- ğŸ‘‰ [å‰ç«¯æœ¬åœ°å­˜å‚¨æ•°æ®åº“ IndexedDB å®Œæ•´æ•™ç¨‹ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/429086021)
- ğŸ‘‰ [HTML5 indexedDB å‰ç«¯æœ¬åœ°å­˜å‚¨æ•°æ®åº“å®ä¾‹æ•™ç¨‹ - å¼ é‘«æ—­çš„ç©ºé—´](https://www.zhangxinxu.com/wordpress/2017/07/html5-indexeddb-js-example/)
- ğŸ‘‰ [æµè§ˆå™¨é‡Œçš„æœ¬åœ°æ•°æ®åº“ï¼šIndexedDB - zoo.team åšå®¢](https://www.zoo.team/article/indexeddb)

:::

## æ€»ç»“ ğŸ“¦

æ€»ç»“ä»¥ä¸Šå„å­˜å‚¨æ–¹å¼çš„åŒºåˆ« & å¯¹æ¯”

|                                | `Cookie`               | `localStorage`                                     | `sessionStorage`                                        | `IndexedDB`                                                               |
| ------------------------------ | ---------------------- | -------------------------------------------------- | ------------------------------------------------------- | ------------------------------------------------------------------------- |
| **ç”Ÿå‘½å‘¨æœŸ(æœ‰æ•ˆæœŸ)**           | å¯æ‰‹åŠ¨è®¾ç½®æœ‰æ•ˆæœŸ       | å¯é•¿æœŸå­˜åœ¨(éœ€ç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤ï¼Œæ¯”å¦‚æ¸…é™¤æµè§ˆå™¨å†å²è®°å½•) | æµè§ˆå™¨çª—å£(æ ‡ç­¾é¡µ)å…³é—­å³æ¸…é™¤                            | å¯é•¿æœŸå­˜åœ¨(éœ€ç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤ï¼Œæ¸…é™¤æµè§ˆå™¨å†å²è®°å½•å¹¶ä¸èƒ½åˆ é™¤ IndexedDB çš„æ•°æ®) |
| **æ˜¯å¦ H5 æ–°å¢**               | --                     | âœ…                                                 | âœ…                                                      | âœ…                                                                        |
| **å­˜å‚¨ä½ç½®**                   | å®¢æˆ·ç«¯                 | æœ¬åœ°ç£ç›˜                                           | å®¢æˆ·ç«¯                                                  | æœ¬åœ°ç£ç›˜                                                                  |
| **å­˜å€¼çš„å®¹é‡ & å¤§å°**          | `<= 4KB`               | `<= 5MB`                                           | `<= 5MB`                                                | æ— é™åˆ¶                                                                    |
| **å­˜å€¼çš„ç±»å‹**                 | å­—ç¬¦ä¸²                 | å­—ç¬¦ä¸²                                             | å­—ç¬¦ä¸²                                                  | ä»»æ„ç±»å‹                                                                  |
| **æ“ä½œæ–¹å¼(åŒæ­¥ or å¼‚æ­¥)**     | åŒæ­¥                   | åŒæ­¥                                               | åŒæ­¥                                                    | å¼‚æ­¥                                                                      |
| **æ˜¯å¦ç¬¦åˆåŒæºç­–ç•¥(ä¸å¯è·¨åŸŸ)** | âœ…                     | âœ…                                                 | âœ… ï¼ˆå³ä½¿åŒæºï¼ŒåŒä¸€é¡µé¢åœ¨ä¸åŒçª—å£æ‰“å¼€ï¼Œæ•°æ®ä¹Ÿä¸ä¼šå…±äº«ï¼‰ | âœ…                                                                        |
| **ä½¿ç”¨åœºæ™¯**                   | å¯åŒæœåŠ¡ç«¯äº¤äº’ï¼Œé‰´æƒç­‰ | å­˜å‚¨ä¸€äº›æ¯”è¾ƒç¨³å®šï¼Œä¸æ€ä¹ˆæ”¹å˜çš„æ•°æ®                 | å­˜å‚¨ä¸€äº›æ•æ„Ÿçš„ï¼Œåªä½¿ç”¨ä¸€æ¬¡çš„æ•°æ®                        | å­˜å‚¨ä¸€äº›å¤æ‚çš„ã€å¤§é‡ç»“æ„åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚äºŒè¿›åˆ¶æ•°æ®                          |

## å‚è€ƒèµ„æ–™

- ğŸ‘‰ [æ·±å…¥äº†è§£æµè§ˆå™¨å­˜å‚¨--ä» cookie åˆ° WebStorageã€IndexedDB - æ˜é‡‘](https://juejin.cn/post/6844903812092674061)
